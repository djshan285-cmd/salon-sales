<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deruja Beauty Hub and Lounge ‚Äî Reports</title>
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="bg-orbs"></div>

  <header class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">
        <img src="assets/logo.png" alt="Logo" />
      </div>
      <div class="topbar-text">
        <div class="topbar-title">Deruja Beauty Hub and Lounge</div>
        <div class="topbar-sub">Reports ‚Ä¢ Print ready</div>
      </div>
    </div>

    <div class="topbar-actions">
      <a class="btn btn-soft" href="app.html">‚Üê <span class="hide-sm">Back</span></a>
      <button id="printBtn" class="btn btn-primary" type="button">üñ® <span class="hide-sm">Print</span></button>
      <button id="logoutBtn" class="btn btn-danger" type="button">‚éã <span class="hide-sm">Logout</span></button>
    </div>
  </header>

  <main class="page">
    <section class="grid-2 report-grid">
      <div class="glass-card card">
        <div class="card-head">
          <h2>Report Selection</h2>
          <p>Select date range or month then click Open</p>
        </div>

        <div class="form">
          <div class="grid-2-sm">
            <label class="field">
              <span>Daily / Range (From)</span>
              <input id="fromDate" type="date" />
            </label>
            <label class="field">
              <span>Daily / Range (To)</span>
              <input id="toDate" type="date" />
            </label>
          </div>

          <div class="grid-2-sm">
            <label class="field">
              <span>Monthly report (month)</span>
              <input id="monthPick" type="month" />
            </label>
            <label class="field">
              <span>Monthly type</span>
              <select id="monthType">
                <option value="salary_workers">Salary (by workers)</option>
                <option value="monthly_breakdown">Monthly payments breakdown</option>
              </select>
            </label>
          </div>

          <div class="btn-grid">
            <button id="openDaily" class="btn btn-primary" type="button">Open daily business</button>
            <button id="openExpenses" class="btn btn-soft" type="button">Open expenses</button>
            <button id="openMonthly" class="btn btn-primary" type="button">Open monthly must</button>
            <button id="openFull" class="btn btn-primary" type="button">Open full summary report</button>
            <button id="openFinance" class="btn btn-primary btn-wide" type="button">Open full financial report</button>
          </div>

          <p id="msg" class="msg"></p>
        </div>
      </div>

      <div class="glass-card card">
        <div class="card-head">
          <h2>Report Output</h2>
          <p>Tip: Print button makes PDF / paper report</p>
        </div>

        <!-- PRINT HEADER (shown only when printing OR when report rendered) -->
        <div id="printHeader" class="print-header">
          <div class="print-brand">
            <img class="print-logo" src="assets/logo.png" alt="Logo" />
            <div class="print-brand-text">
              <div class="print-name">Deruja Beauty Hub and Lounge</div>
              <div class="print-meta">
                No39/A new rosita bazar kotagala<br />
                Mobile No: 051-224 4456 / 076-669 3456
              </div>
              <div id="printMeta" class="print-small"></div>
            </div>
          </div>
          <hr class="print-hr" />
        </div>

        <div id="output" class="report-output">
          <div class="empty-note">Select a report and click Open.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ‚úÖ YOUR CONFIG (kept exactly)
    const firebaseConfig = {
      apiKey: "AIzaSyB_pQt0C5X3R9tmVl8SRGT-DQ3eoNvdOEw",
      authDomain: "salonsales-32a19.firebaseapp.com",
      projectId: "salonsales-32a19",
      storageBucket: "salonsales-32a19.firebasestorage.app",
      messagingSenderId: "727392891815",
      appId: "1:727392891815:web:1ea28d2335b6ee9a363c82"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Collections (match app.html)
    const COL_DAILY = "dailySales";
    const COL_MONTHLY = "monthlyExpenses";

    const $ = (id) => document.getElementById(id);

    const msg = $("msg");
    const output = $("output");
    const printMeta = $("printMeta");
    const printHeader = $("printHeader");

    let chartLine = null;
    let chartPie = null;

    // LKR money formatter (with normal space)
    const money = (n) => {
      const v = Number(n || 0);
      return new Intl.NumberFormat("en-LK", {
        style: "currency",
        currency: "LKR",
        minimumFractionDigits: 2
      }).format(v).replace(/\u00A0/g, " ");
    };

    // 01-Jan-26 format
    const fmtDate = (iso) => {
      if (!iso) return "";
      const d = new Date(iso + "T00:00:00");
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}-${mm}-${yy}`;
    };

    const fmtMonth = (ym) => {
      // ym = YYYY-MM
      if (!ym) return "";
      const [y,m] = ym.split("-").map(Number);
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${months[m-1]} ${y}`;
    };

    const getRange = () => {
      const from = $("fromDate").value;
      const to = $("toDate").value;
      if (!from || !to) return null;
      if (from > to) return null;
      return { from, to };
    };

    const monthKeysBetween = (from, to) => {
      const out = [];
      const d1 = new Date(from + "T00:00:00");
      const d2 = new Date(to + "T00:00:00");
      const d = new Date(d1.getFullYear(), d1.getMonth(), 1);
      const end = new Date(d2.getFullYear(), d2.getMonth(), 1);
      while (d <= end) {
        out.push(d.toISOString().slice(0, 7)); // YYYY-MM
        d.setMonth(d.getMonth() + 1);
      }
      return out;
    };

    const destroyCharts = () => {
      if (chartLine) { chartLine.destroy(); chartLine = null; }
      if (chartPie) { chartPie.destroy(); chartPie = null; }
    };

    const setPrintMeta = (title, rangeText) => {
      const now = new Date();
      const printed = now.toLocaleString();
      printMeta.textContent = `${title} | ${rangeText} | Printed: ${printed}`;
      // show header on screen when report exists
      printHeader.style.display = "block";
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "index.html";
    });

    $("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    $("printBtn").addEventListener("click", () => window.print());

    // ---------------------------
    // Firestore loaders
    // ---------------------------
    async function loadDailyDocs(from, to) {
      // date string ISO, so string compare works
      const q = query(
        collection(db, COL_DAILY),
        where("date", ">=", from),
        where("date", "<=", to)
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach((doc) => rows.push({ id: doc.id, ...doc.data() }));
      // sort by date
      rows.sort((a,b) => (a.date || "").localeCompare(b.date || ""));
      return rows;
    }

    async function loadMonthlyDocsForMonths(monthKeys) {
      if (!monthKeys.length) return [];
      // Firestore "in" max 30. Your month list is small normally.
      const q = query(
        collection(db, COL_MONTHLY),
        where("monthKey", "in", monthKeys.slice(0, 30))
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach((doc) => rows.push({ id: doc.id, ...doc.data() }));
      return rows;
    }

    // ---------------------------
    // REPORT 1: Daily Business
    // ---------------------------
    $("openDaily").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) {
        msg.className = "msg msg-warn";
        msg.textContent = "Select valid From and To dates.";
        return;
      }

      destroyCharts();

      const daily = await loadDailyDocs(r.from, r.to);
      const totalBusiness = daily.reduce((s,x) => s + Number(x.business || 0), 0);
      const totalBank = daily.reduce((s,x) => s + Number(x.bankSaving || 0), 0);

      setPrintMeta("Daily Business Report", `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      output.innerHTML = `
        <div class="report-card">
          <h3>Daily Business Report</h3>
          <div class="muted">Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}</div>

          <div class="table-wrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="t-right">Business</th>
                  <th class="t-right">Bank saving</th>
                </tr>
              </thead>
              <tbody>
                ${daily.map(x => `
                  <tr>
                    <td>${x.date || ""}</td>
                    <td class="t-right">${money(x.business)}</td>
                    <td class="t-right">${money(x.bankSaving)}</td>
                  </tr>
                `).join("")}
              </tbody>
              <tfoot>
                <tr>
                  <td><b>Totals</b></td>
                  <td class="t-right"><b>${money(totalBusiness)}</b></td>
                  <td class="t-right"><b>${money(totalBank)}</b></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
    };

    // ---------------------------
    // REPORT 2: Daily Expenses
    // ---------------------------
    $("openExpenses").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) {
        msg.className = "msg msg-warn";
        msg.textContent = "Select valid From and To dates.";
        return;
      }

      destroyCharts();

      const daily = await loadDailyDocs(r.from, r.to);
      const totalExp = daily.reduce((s,x) => s + Number(x.sameDayExpenses || 0), 0);

      setPrintMeta("Total Expenses Report (Daily)", `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      output.innerHTML = `
        <div class="report-card">
          <h3>Total Expenses Report (Daily)</h3>
          <div class="muted">Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}</div>

          <div class="table-wrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="t-right">Same-day Expenses</th>
                </tr>
              </thead>
              <tbody>
                ${daily.map(x => `
                  <tr>
                    <td>${x.date || ""}</td>
                    <td class="t-right">${money(x.sameDayExpenses)}</td>
                  </tr>
                `).join("")}
              </tbody>
              <tfoot>
                <tr>
                  <td><b>Total daily expenses</b></td>
                  <td class="t-right"><b>${money(totalExp)}</b></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
    };

    // ---------------------------
    // REPORT 3: Monthly Must
    // ---------------------------
    $("openMonthly").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const ym = $("monthPick").value;
      if (!ym) {
        msg.className = "msg msg-warn";
        msg.textContent = "Select a month.";
        return;
      }

      destroyCharts();

      const q = query(collection(db, COL_MONTHLY), where("monthKey", "==", ym));
      const snap = await getDocs(q);

      const rows = [];
      snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));

      const type = $("monthType").value;

      if (type === "salary_workers") {
        const byWorker = {};
        rows.filter(x => x.type === "salary").forEach(x => {
          const name = (x.workerName || "Unknown").trim() || "Unknown";
          byWorker[name] = (byWorker[name] || 0) + Number(x.amount || 0);
        });
        const items = Object.entries(byWorker).sort((a,b)=>b[1]-a[1]);
        const total = items.reduce((s, [,v]) => s + v, 0);

        setPrintMeta("Monthly Salary Report (By workers)", `Month: ${fmtMonth(ym)}`);

        output.innerHTML = `
          <div class="report-card">
            <h3>Monthly Salary Report (By workers)</h3>
            <div class="muted">Month: ${ym}</div>

            <div class="table-wrap">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Worker</th>
                    <th class="t-right">Total salary paid</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(([name, val]) => `
                    <tr>
                      <td>${name}</td>
                      <td class="t-right">${money(val)}</td>
                    </tr>
                  `).join("")}
                </tbody>
                <tfoot>
                  <tr>
                    <td><b>Total salaries paid</b></td>
                    <td class="t-right"><b>${money(total)}</b></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        `;
        return;
      }

      // monthly_breakdown
      const totals = { salary:0, rent:0, water:0, electric:0, other:0 };
      rows.forEach(x => {
        const t = x.type || "other";
        if (totals[t] === undefined) totals.other += Number(x.amount || 0);
        else totals[t] += Number(x.amount || 0);
      });
      const grand = Object.values(totals).reduce((s,v)=>s+v,0);

      setPrintMeta("Monthly Payments Breakdown", `Month: ${fmtMonth(ym)}`);

      output.innerHTML = `
        <div class="report-card">
          <h3>Monthly Payments Breakdown</h3>
          <div class="muted">Month: ${ym}</div>

          <div class="table-wrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th>Type</th>
                  <th class="t-right">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Salary</td><td class="t-right">${money(totals.salary)}</td></tr>
                <tr><td>Rent</td><td class="t-right">${money(totals.rent)}</td></tr>
                <tr><td>Water</td><td class="t-right">${money(totals.water)}</td></tr>
                <tr><td>Electric</td><td class="t-right">${money(totals.electric)}</td></tr>
                <tr><td>Other</td><td class="t-right">${money(totals.other)}</td></tr>
              </tbody>
              <tfoot>
                <tr>
                  <td><b>Total monthly payments</b></td>
                  <td class="t-right"><b>${money(grand)}</b></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
    };

    // ---------------------------
    // REPORT 4: Full Summary (old style)
    // ---------------------------
    $("openFull").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) {
        msg.className = "msg msg-warn";
        msg.textContent = "Select valid From and To dates.";
        return;
      }

      destroyCharts();

      const daily = await loadDailyDocs(r.from, r.to);
      const months = monthKeysBetween(r.from, r.to);
      const monthly = await loadMonthlyDocsForMonths(months);

      const totalSales = daily.reduce((s,x)=>s+Number(x.business||0),0);
      const totalDailyExp = daily.reduce((s,x)=>s+Number(x.sameDayExpenses||0),0);
      const totalBank = daily.reduce((s,x)=>s+Number(x.bankSaving||0),0);

      const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
      monthly.forEach(x => {
        const t = x.type || "other";
        const amt = Number(x.amount || 0);
        if (byType[t] === undefined) byType.other += amt;
        else byType[t] += amt;
      });
      const totalMonthly = Object.values(byType).reduce((s,v)=>s+v,0);

      const totalExpenses = totalDailyExp + totalMonthly;
      const netProfit = totalSales - totalExpenses;

      setPrintMeta("Full Summary Report", `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      output.innerHTML = `
        <div class="report-card">
          <h3>Full Summary Report</h3>
          <div class="muted">Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}</div>

          <div class="kpi-grid">
            <div class="kpi"><div class="kpi-l">Total Sales</div><div class="kpi-v">${money(totalSales)}</div></div>
            <div class="kpi"><div class="kpi-l">Total Expenses</div><div class="kpi-v">${money(totalExpenses)}</div><div class="kpi-s">Daily: ${money(totalDailyExp)} ‚Ä¢ Monthly: ${money(totalMonthly)}</div></div>
            <div class="kpi"><div class="kpi-l">Net Profit</div><div class="kpi-v">${money(netProfit)}</div><div class="kpi-s">(Profit = Sales ‚àí Expenses)</div></div>
            <div class="kpi"><div class="kpi-l">Bank Saving (separate)</div><div class="kpi-v">${money(totalBank)}</div><div class="kpi-s">Not included in profit</div></div>
          </div>

          <div class="split">
            <div class="mini">
              <h4>Monthly payments breakdown</h4>
              <table class="tbl">
                <tbody>
                  <tr><td>Salary</td><td class="t-right">${money(byType.salary)}</td></tr>
                  <tr><td>Rent</td><td class="t-right">${money(byType.rent)}</td></tr>
                  <tr><td>Water</td><td class="t-right">${money(byType.water)}</td></tr>
                  <tr><td>Electric</td><td class="t-right">${money(byType.electric)}</td></tr>
                  <tr><td>Other</td><td class="t-right">${money(byType.other)}</td></tr>
                </tbody>
                <tfoot>
                  <tr><td><b>Total monthly payments</b></td><td class="t-right"><b>${money(totalMonthly)}</b></td></tr>
                </tfoot>
              </table>
            </div>

            <div class="mini">
              <h4>Quick insights</h4>
              ${(() => {
                const dailyRows = daily.map(d => ({
                  date: d.date,
                  sales: Number(d.business||0),
                  exp: Number(d.sameDayExpenses||0),
                  profit: Number(d.business||0) - Number(d.sameDayExpenses||0)
                }));
                if (!dailyRows.length) return `<div class="muted">No daily data in range.</div>`;
                const best = [...dailyRows].sort((a,b)=>b.profit-a.profit)[0];
                const worst = [...dailyRows].sort((a,b)=>a.profit-b.profit)[0];
                const highExp = [...dailyRows].sort((a,b)=>b.exp-a.exp)[0];
                return `
                  <ul class="bullets">
                    <li>‚úÖ Best profit day: <b>${best.date}</b> (${money(best.profit)})</li>
                    <li>‚ö†Ô∏è Lowest profit day: <b>${worst.date}</b> (${money(worst.profit)})</li>
                    <li>üí∏ Highest daily expense: <b>${highExp.date}</b> (${money(highExp.exp)})</li>
                  </ul>
                `;
              })()}
            </div>
          </div>
        </div>
      `;
    };

    // ---------------------------
    // REPORT 5: Full Financial Report (NEW)
    // Includes: total expenses = daily + monthly (salary/rent/water/electric/other)
    // Adds: current available balance
    // Adds: tables + charts
    // ---------------------------
    $("openFinance").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) {
        msg.className = "msg msg-warn";
        msg.textContent = "Select valid From and To dates.";
        return;
      }

      destroyCharts();

      const daily = await loadDailyDocs(r.from, r.to);
      const months = monthKeysBetween(r.from, r.to);
      const monthly = await loadMonthlyDocsForMonths(months);

      // Totals
      const totalSales = daily.reduce((s,x)=>s+Number(x.business||0),0);
      const totalDailyExp = daily.reduce((s,x)=>s+Number(x.sameDayExpenses||0),0);
      const totalBank = daily.reduce((s,x)=>s+Number(x.bankSaving||0),0);

      const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
      monthly.forEach(x => {
        const t = x.type || "other";
        const amt = Number(x.amount || 0);
        if (byType[t] === undefined) byType.other += amt;
        else byType[t] += amt;
      });
      const totalMonthly = Object.values(byType).reduce((s,v)=>s+v,0);

      // ‚úÖ IMPORTANT: total expenses ALL = daily + monthly
      const totalExpensesAll = totalDailyExp + totalMonthly;

      const netProfit = totalSales - totalExpensesAll;

      // "Current available balance"
      // If you treat bank saving as separate cash moved to bank:
      // Available Balance = Net Profit + Bank Saving
      const currentBalance = netProfit + totalBank;

      // Build daily series for chart
      const dailyRows = daily.map(d => ({
        date: d.date,
        sales: Number(d.business||0),
        exp: Number(d.sameDayExpenses||0),
        profit: Number(d.business||0) - Number(d.sameDayExpenses||0)
      }));

      setPrintMeta("Full Financial Report", `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      output.innerHTML = `
        <div class="report-card">
          <h3>Full Financial Report</h3>
          <div class="muted">Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}</div>

          <div class="kpi-grid">
            <div class="kpi"><div class="kpi-l">Total Sales</div><div class="kpi-v">${money(totalSales)}</div></div>

            <div class="kpi">
              <div class="kpi-l">Total Expenses (ALL)</div>
              <div class="kpi-v">${money(totalExpensesAll)}</div>
              <div class="kpi-s">Daily: ${money(totalDailyExp)} ‚Ä¢ Monthly: ${money(totalMonthly)}</div>
            </div>

            <div class="kpi">
              <div class="kpi-l">Net Profit</div>
              <div class="kpi-v">${money(netProfit)}</div>
              <div class="kpi-s">(Sales ‚àí Daily ‚àí Monthly)</div>
            </div>

            <div class="kpi">
              <div class="kpi-l">Current available balance</div>
              <div class="kpi-v">${money(currentBalance)}</div>
              <div class="kpi-s">Net Profit + Bank Saving (${money(totalBank)})</div>
            </div>
          </div>

          <div class="chart-card">
            <h4>Daily Sales vs Daily Expenses</h4>
            <canvas id="lineChart" height="120"></canvas>
          </div>

          <div class="chart-card">
            <h4>Expense breakdown (Monthly payments)</h4>
            <canvas id="pieChart" height="120"></canvas>
          </div>

          <div class="split">
            <div class="mini">
              <h4>Daily summary table</h4>
              <div class="table-wrap">
                <table class="tbl">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th class="t-right">Sales</th>
                      <th class="t-right">Daily expenses</th>
                      <th class="t-right">Bank saving</th>
                      <th class="t-right">Profit (day)</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${dailyRows.map(x => `
                      <tr>
                        <td>${x.date}</td>
                        <td class="t-right">${money(x.sales)}</td>
                        <td class="t-right">${money(x.exp)}</td>
                        <td class="t-right">${money(daily.find(d=>d.date===x.date)?.bankSaving || 0)}</td>
                        <td class="t-right">${money(x.profit)}</td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mini">
              <h4>Monthly payments breakdown (within range)</h4>
              <div class="table-wrap">
                <table class="tbl">
                  <thead>
                    <tr><th>Type</th><th class="t-right">Total</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>Salary</td><td class="t-right">${money(byType.salary)}</td></tr>
                    <tr><td>Rent</td><td class="t-right">${money(byType.rent)}</td></tr>
                    <tr><td>Water</td><td class="t-right">${money(byType.water)}</td></tr>
                    <tr><td>Electric</td><td class="t-right">${money(byType.electric)}</td></tr>
                    <tr><td>Other</td><td class="t-right">${money(byType.other)}</td></tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td><b>Total monthly payments</b></td>
                      <td class="t-right"><b>${money(totalMonthly)}</b></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="note-box">
                ‚úÖ Total Expenses (ALL) = Daily expenses (${money(totalDailyExp)}) + Monthly payments (${money(totalMonthly)}) = <b>${money(totalExpensesAll)}</b>
              </div>
            </div>
          </div>
        </div>
      `;

      // Build charts
      const labels = dailyRows.map(x => x.date);
      const sales = dailyRows.map(x => x.sales);
      const exps = dailyRows.map(x => x.exp);

      const lineCtx = document.getElementById("lineChart");
      chartLine = new Chart(lineCtx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Sales", data: sales, tension: 0.25 },
            { label: "Daily Expenses", data: exps, tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#e9e3ff" } } },
          scales: {
            x: { ticks: { color: "#cfc6ff" }, grid: { color: "rgba(255,255,255,0.08)" } },
            y: { ticks: { color: "#cfc6ff" }, grid: { color: "rgba(255,255,255,0.08)" } }
          }
        }
      });

      const pieCtx = document.getElementById("pieChart");
      chartPie = new Chart(pieCtx, {
        type: "doughnut",
        data: {
          labels: ["Salary","Rent","Water","Electric","Other"],
          datasets: [{
            data: [byType.salary, byType.rent, byType.water, byType.electric, byType.other]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#e9e3ff" } } }
        }
      });
    };
  </script>
</body>
</html>
