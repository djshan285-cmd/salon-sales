// ---------- FULL SUMMARY (ALL IN ONE + CHARTS + TABLES) ----------
function monthKeysBetween(from, to){
  const out = [];
  const d1 = new Date(from + "T00:00:00");
  const d2 = new Date(to + "T00:00:00");
  const d = new Date(d1.getFullYear(), d1.getMonth(), 1);
  const end = new Date(d2.getFullYear(), d2.getMonth(), 1);
  while (d <= end){
    out.push(d.toISOString().slice(0,7));
    d.setMonth(d.getMonth() + 1);
  }
  return out;
}

let chartLine = null;
let chartPie = null;

document.getElementById("openFull").onclick = async () => {
  msg.className="msg"; msg.textContent="";

  const r = getRange();
  if (!r) { msg.className="msg msgErr"; msg.textContent="Select valid From and To dates."; return; }

  setPrintTitle("Full Summary Report (All-in-One)", `Range: ${r.from} to ${r.to}`);

  // ---- DAILY SALES (range) ----
  const qDaily = query(
    collection(db, "dailySales"),
    where("date", ">=", r.from),
    where("date", "<=", r.to)
  );
  const snapDaily = await getDocs(qDaily);

  let totalSales = 0, totalDailyExp = 0, totalBank = 0;
  const dailyRows = [];
  snapDaily.forEach(d => {
    const x = d.data();
    const business = Number(x.businessTotal || 0);
    const exp = Number(x.sameDayExpenses || 0);
    const bank = Number(x.bankSaving || 0);
    totalSales += business;
    totalDailyExp += exp;
    totalBank += bank;
    dailyRows.push({ date:x.date, business, exp, bank, profit: (business - exp) });
  });
  dailyRows.sort((a,b)=>a.date.localeCompare(b.date));

  // Best/worst day stats
  const bestDay = [...dailyRows].sort((a,b)=>b.profit-a.profit)[0];
  const worstDay = [...dailyRows].sort((a,b)=>a.profit-b.profit)[0];
  const highestExpenseDay = [...dailyRows].sort((a,b)=>b.exp-a.exp)[0];

  // ---- MONTHLY MUST (for all months in range) ----
  const months = monthKeysBetween(r.from, r.to);
  const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
  let totalMonthlyMust = 0;

  for (const mk of months){
    const qMust = query(collection(db,"monthlyExpenses"), where("monthKey","==", mk));
    const snapMust = await getDocs(qMust);
    snapMust.forEach(doc => {
      const x = doc.data();
      const amt = Number(x.amount || 0);
      totalMonthlyMust += amt;

      const t = (x.type || "other");
      if (byType[t] === undefined) byType.other += amt;
      else byType[t] += amt;
    });
  }

  const totalExpenses = totalDailyExp + totalMonthlyMust;
  const netProfit = totalSales - totalExpenses;

  // Table HTML (Daily)
  const dailyTableHTML = `
    <div style="font-weight:900; margin: 8px 0 10px;">Daily Summary Table</div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Sales</th>
          <th>Daily expenses</th>
          <th>Bank saving</th>
          <th style="text-align:right;">Profit (day)</th>
        </tr>
      </thead>
      <tbody>
        ${dailyRows.map(x => `
          <tr>
            <td>${x.date}</td>
            <td>${money(x.business)}</td>
            <td>${money(x.exp)}</td>
            <td>${money(x.bank)}</td>
            <td style="text-align:right;">${money(x.profit)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  // Table HTML (Monthly must)
  const monthlyTableHTML = `
    <div style="font-weight:900; margin: 18px 0 10px;">Monthly Must Breakdown (within selected range)</div>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Salaries</td><td style="text-align:right;">${money(byType.salary)}</td></tr>
        <tr><td>Rent</td><td style="text-align:right;">${money(byType.rent)}</td></tr>
        <tr><td>Water</td><td style="text-align:right;">${money(byType.water)}</td></tr>
        <tr><td>Electric</td><td style="text-align:right;">${money(byType.electric)}</td></tr>
        ${byType.other > 0 ? `<tr><td>Other</td><td style="text-align:right;">${money(byType.other)}</td></tr>` : ""}
      </tbody>
      <tfoot>
        <tr>
          <th>Total monthly must</th>
          <th style="text-align:right;">${money(totalMonthlyMust)}</th>
        </tr>
      </tfoot>
    </table>
  `;

  // Main Output
  output.innerHTML = `
    <div style="font-weight:950; font-size:15px; margin-bottom:6px;">Full Summary Report</div>
    <div class="smallMuted">Range: ${r.from} to ${r.to}</div>
    <br/>

    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
      <div class="card" style="padding:12px;">
        <div class="smallMuted">Total Sales</div>
        <div style="font-size:18px; font-weight:950;">${money(totalSales)}</div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="smallMuted">Total Expenses</div>
        <div style="font-size:18px; font-weight:950;">${money(totalExpenses)}</div>
        <div class="smallMuted" style="margin-top:6px;">Daily: ${money(totalDailyExp)} ‚Ä¢ Monthly: ${money(totalMonthlyMust)}</div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="smallMuted">Net Profit</div>
        <div style="font-size:18px; font-weight:950;">${money(netProfit)}</div>
        <div class="smallMuted" style="margin-top:6px;">(Profit = Sales ‚àí Expenses)</div>
      </div>

      <div class="card" style="padding:12px;">
        <div class="smallMuted">Bank Saving (not included in profit)</div>
        <div style="font-size:18px; font-weight:950;">${money(totalBank)}</div>
      </div>
    </div>

    <br/>

    <div class="card" style="padding:12px; margin-bottom: 12px;">
      <div style="font-weight:900; margin-bottom:8px;">Quick Insights</div>
      <div class="smallMuted" style="line-height:1.8;">
        ${bestDay ? `‚úÖ Best profit day: <b>${bestDay.date}</b> (${money(bestDay.profit)})<br/>` : ""}
        ${worstDay ? `‚ö†Ô∏è Lowest profit day: <b>${worstDay.date}</b> (${money(worstDay.profit)})<br/>` : ""}
        ${highestExpenseDay ? `üí∏ Highest expense day: <b>${highestExpenseDay.date}</b> (${money(highestExpenseDay.exp)})` : ""}
      </div>
    </div>

    <div class="card" style="padding:12px; margin-bottom: 12px;">
      <div style="font-weight:900; margin-bottom:8px;">Daily Sales vs Daily Expenses</div>
      <canvas id="chartLine" height="140"></canvas>
    </div>

    <div class="card" style="padding:12px; margin-bottom: 12px;">
      <div style="font-weight:900; margin-bottom:8px;">Expense Breakdown (Monthly Must)</div>
      <canvas id="chartPie" height="160"></canvas>
    </div>

    <div class="card" style="padding:12px;">
      ${dailyTableHTML}
      ${monthlyTableHTML}
    </div>
  `;

  // Charts data
  const labels = dailyRows.map(x=>x.date);
  const salesData = dailyRows.map(x=>x.business);
  const expData = dailyRows.map(x=>x.exp);

  if (chartLine) chartLine.destroy();
  if (chartPie) chartPie.destroy();

  chartLine = new Chart(document.getElementById("chartLine"), {
    type: "line",
    data: { labels, datasets: [
      { label:"Sales", data: salesData },
      { label:"Daily Expenses", data: expData }
    ]},
    options: { responsive:true, plugins:{ legend:{ display:true } } }
  });

  chartPie = new Chart(document.getElementById("chartPie"), {
    type: "doughnut",
    data: { labels:["Salary","Rent","Water","Electric","Other"], datasets:[{
      data:[byType.salary,byType.rent,byType.water,byType.electric,byType.other]
    }]},
    options: { responsive:true, plugins:{ legend:{ display:true } } }
  });
};
