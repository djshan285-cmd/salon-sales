<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deruja Beauty Hub and Lounge - Reports</title>

  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg">
  <div class="page">
    <!-- Top Header -->
    <header class="topbar">
      <div class="brand">
        <img class="brandLogo" src="./assets/logo.png" alt="Logo" />
        <div class="brandText">
          <div class="brandName">Deruja Beauty Hub and Lounge</div>
          <div class="brandSub">Reports ‚Ä¢ Print ready</div>
        </div>
      </div>

      <div class="topActions">
        <a class="btn btnGhost" href="./app.html">‚Üê Back</a>
        <button id="btnPrint" class="btn btnPrimary">üñ® Print</button>
        <button id="btnLogout" class="btn btnDanger">‚éã Logout</button>
      </div>
    </header>

    <!-- Main Grid -->
    <main class="grid2">
      <!-- Left: selection -->
      <section class="card">
        <div class="cardTitle">Report Selection</div>
        <div class="cardHint">Select date range or month then click Open</div>

        <div class="formGrid2">
          <div class="field">
            <label>Daily / Range (From)</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field">
            <label>Daily / Range (To)</label>
            <input id="toDate" type="date" />
          </div>

          <div class="field">
            <label>Monthly report (month)</label>
            <input id="monthPick" type="month" />
          </div>

          <div class="field">
            <label>Monthly type</label>
            <select id="monthlyType">
              <option value="salary_workers">Salary (by workers)</option>
              <option value="rent">Rent</option>
              <option value="water">Water</option>
              <option value="electric">Electric</option>
              <option value="other">Other</option>
              <option value="all">All monthly must (breakdown)</option>
            </select>
          </div>
        </div>

        <!-- Buttons: nice spacing + responsive -->
        <div class="btnGrid">
          <button id="openDaily" class="btn btnPrimary">Open daily business</button>
          <button id="openExpenses" class="btn btnGhost">Open expenses</button>
          <button id="openMonthly" class="btn btnPrimary">Open monthly must</button>
          <button id="openSummary" class="btn btnPrimary">Open full summary report</button>
          <button id="openFinancial" class="btn btnPrimary btnWide">Open full financial report</button>
        </div>

        <div id="msg" class="msg"></div>
      </section>

      <!-- Right: output -->
      <section class="card">
        <div class="cardTitle">Report Output</div>
        <div class="cardHint">Tip: Print button makes PDF / paper report</div>

        <!-- PRINT HEADER (only shows in print) -->
        <div class="printHeader" id="printHeader">
          <div class="printHeaderInner">
            <img class="printLogo" src="./assets/logo.png" alt="Logo" />
            <div class="printMeta">
              <div class="printName">Deruja Beauty Hub and Lounge</div>
              <div class="printLine">No39/A new rosita bazar kotagala</div>
              <div class="printLine">Mobile No: 051-224 4456 / 076-669 3456</div>
              <div class="printLine" id="printRangeLine">Report</div>
              <div class="printLine" id="printTimeLine"></div>
            </div>
          </div>
          <hr class="printHr">
        </div>

        <div id="output" class="outputEmpty">
          Select a report and click Open.
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // Firebase (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ‚úÖ YOUR CONFIG (already correct)
    const firebaseConfig = {
      apiKey: "AIzaSyB_pQt0C5X3R9tmVl8SRGT-DQ3eoNvdOEw",
      authDomain: "salonsales-32a19.firebaseapp.com",
      projectId: "salonsales-32a19",
      storageBucket: "salonsales-32a19.firebasestorage.app",
      messagingSenderId: "727392891815",
      appId: "1:727392891815:web:1ea28d2335b6ee9a363c82"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- helpers ----------
    const msg = document.getElementById("msg");
    const output = document.getElementById("output");
    const printRangeLine = document.getElementById("printRangeLine");
    const printTimeLine = document.getElementById("printTimeLine");

    const money = (n) => new Intl.NumberFormat("en-LK", {
      style: "currency",
      currency: "LKR",
      minimumFractionDigits: 2
    }).format(Number(n || 0));

    // ISO date -> 01-Jan-26
    const fmtDate = (iso) => {
      if (!iso) return "";
      const d = new Date(iso + "T00:00:00");
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = months[d.getMonth()];
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}-${mm}-${yy}`;
    };

    const nowStamp = () => {
      const d = new Date();
      return d.toLocaleString("en-LK", { hour12: true });
    };

    const setMessage = (t, kind="") => {
      msg.className = "msg " + (kind ? ("msg_" + kind) : "");
      msg.textContent = t || "";
    };

    const setPrintMeta = (title, rangeText) => {
      printRangeLine.textContent = rangeText ? `${title} ‚Ä¢ Range: ${rangeText}` : title;
      printTimeLine.textContent = "Printed: " + nowStamp();
    };

    function getRange() {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      if (!from || !to) return null;
      if (from > to) return null;
      return { from, to };
    }

    function monthKeyOf(inputMonth) {
      // inputMonth = "2026-01"
      return inputMonth || "";
    }

    function monthKeysBetween(from, to) {
      const out = [];
      const d1 = new Date(from + "T00:00:00");
      const d2 = new Date(to + "T00:00:00");
      const d = new Date(d1.getFullYear(), d1.getMonth(), 1);
      const end = new Date(d2.getFullYear(), d2.getMonth(), 1);
      while (d <= end) {
        out.push(d.toISOString().slice(0,7)); // YYYY-MM
        d.setMonth(d.getMonth() + 1);
      }
      return out;
    }

    // ---------- auth guard ----------
    onAuthStateChanged(auth, (user) => {
      if (!user) location.href = "./index.html";
    });

    document.getElementById("btnLogout").onclick = async () => {
      await signOut(auth);
      location.href = "./index.html";
    };

    document.getElementById("btnPrint").onclick = () => window.print();

    // ---------- Firestore collections (must match your app.html writes) ----------
    // If your app uses different names, change ONLY these 2 lines to match:
    const COL_DAILY = "dailySales";
    const COL_MONTHLY = "monthlyExpenses";

    // ---------- render helpers ----------
    function cardBox(title, subtitle, innerHtml) {
      return `
        <div class="reportCard">
          <div class="reportHead">
            <div class="reportTitle">${title}</div>
            ${subtitle ? `<div class="reportSub">${subtitle}</div>` : ``}
          </div>
          <div class="reportBody">${innerHtml}</div>
        </div>
      `;
    }

    function tableHtml(headers, rowsHtml) {
      return `
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
      `;
    }

    // Charts (destroy old)
    let chartLine = null;
    let chartPie = null;

    function ensureChartsDestroyed() {
      if (chartLine) { chartLine.destroy(); chartLine = null; }
      if (chartPie) { chartPie.destroy(); chartPie = null; }
    }

    // ---------- queries ----------
    async function fetchDaily(from, to) {
      const q = query(
        collection(db, COL_DAILY),
        where("date", ">=", from),
        where("date", "<=", to),
        orderBy("date", "asc")
      );
      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
      return rows;
    }

    async function fetchMonthlyForMonths(monthKeys) {
      if (!monthKeys.length) return [];
      // Firestore 'in' supports max 10, so chunk it
      const chunks = [];
      for (let i=0;i<monthKeys.length;i+=10) chunks.push(monthKeys.slice(i,i+10));

      const out = [];
      for (const ch of chunks) {
        const q = query(
          collection(db, COL_MONTHLY),
          where("monthKey", "in", ch)
        );
        const snap = await getDocs(q);
        snap.forEach(doc => out.push({ id: doc.id, ...doc.data() }));
      }
      return out;
    }

    async function fetchMonthlyOneMonth(monthKey) {
      const q = query(collection(db, COL_MONTHLY), where("monthKey","==", monthKey));
      const snap = await getDocs(q);
      const out = [];
      snap.forEach(doc => out.push({ id: doc.id, ...doc.data() }));
      return out;
    }

    // ---------- button: Daily Business ----------
    document.getElementById("openDaily").onclick = async () => {
      ensureChartsDestroyed();
      setMessage("");

      const r = getRange();
      if (!r) return setMessage("Select valid From and To dates.", "bad");

      setPrintMeta("Daily Business Report", `${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      const daily = await fetchDaily(r.from, r.to);

      let totalBusiness = 0;
      let totalBank = 0;

      const rowsHtml = daily.map(x => {
        const business = Number(x.business || 0);
        const bank = Number(x.bankSaving || x.bank || 0);
        totalBusiness += business;
        totalBank += bank;
        return `
          <tr>
            <td>${x.date || ""}</td>
            <td class="tRight">${money(business)}</td>
            <td class="tRight">${money(bank)}</td>
          </tr>
        `;
      }).join("");

      const tbl = tableHtml(
        ["Date", "Business", "Bank saving"],
        rowsHtml || `<tr><td colspan="3" class="tCenter muted">No data in range</td></tr>`
      );

      const footer = `
        <div class="totals">
          <div><b>Total business:</b> ${money(totalBusiness)}</div>
          <div><b>Total bank saving:</b> ${money(totalBank)}</div>
        </div>
      `;

      output.className = "";
      output.innerHTML = cardBox(
        "Daily Business Report",
        `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`,
        tbl + footer
      );
    };

    // ---------- button: Daily Expenses ----------
    document.getElementById("openExpenses").onclick = async () => {
      ensureChartsDestroyed();
      setMessage("");

      const r = getRange();
      if (!r) return setMessage("Select valid From and To dates.", "bad");

      setPrintMeta("Total Expenses Report (Daily)", `${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      const daily = await fetchDaily(r.from, r.to);

      let totalExp = 0;

      const rowsHtml = daily.map(x => {
        const exp = Number(x.sameDayExpenses || x.expenses || x.exp || 0);
        totalExp += exp;
        return `
          <tr>
            <td>${x.date || ""}</td>
            <td class="tRight">${money(exp)}</td>
          </tr>
        `;
      }).join("");

      const tbl = tableHtml(
        ["Date", "Same-day Expenses"],
        rowsHtml || `<tr><td colspan="2" class="tCenter muted">No data in range</td></tr>`
      );

      const footer = `
        <div class="totals">
          <div><b>Total daily expenses:</b> ${money(totalExp)}</div>
        </div>
      `;

      output.className = "";
      output.innerHTML = cardBox(
        "Total Expenses Report (Daily)",
        `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`,
        tbl + footer
      );
    };

    // ---------- button: Monthly Must ----------
    document.getElementById("openMonthly").onclick = async () => {
      ensureChartsDestroyed();
      setMessage("");

      const monthKey = monthKeyOf(document.getElementById("monthPick").value);
      if (!monthKey) return setMessage("Select a month first.", "bad");

      const type = document.getElementById("monthlyType").value;

      setPrintMeta("Monthly Must Report", `Month: ${monthKey}`);

      const rows = await fetchMonthlyOneMonth(monthKey);

      const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
      rows.forEach(r => {
        const t = (r.type || "other").toLowerCase();
        const amt = Number(r.amount || 0);
        if (byType[t] === undefined) byType.other += amt;
        else byType[t] += amt;
      });

      // Salary by workers
      if (type === "salary_workers") {
        const map = {};
        rows.filter(r => (r.type || "").toLowerCase() === "salary").forEach(r => {
          const w = (r.workerName || "Unknown").trim();
          map[w] = (map[w] || 0) + Number(r.amount || 0);
        });

        const workers = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const total = workers.reduce((s, [,v])=>s+v, 0);

        const rowsHtml = workers.map(([w,v])=>`
          <tr>
            <td>${w}</td>
            <td class="tRight">${money(v)}</td>
          </tr>
        `).join("");

        const tbl = tableHtml(
          ["Worker", "Total salary paid"],
          rowsHtml || `<tr><td colspan="2" class="tCenter muted">No salary records for this month</td></tr>`
        );

        output.className = "";
        output.innerHTML = cardBox(
          "Monthly Salary Report (By workers)",
          `Month: ${monthKey}`,
          tbl + `<div class="totals"><div><b>Total salaries paid:</b> ${money(total)}</div></div>`
        );
        return;
      }

      // Single type totals
      if (["rent","water","electric","other"].includes(type)) {
        const total = byType[type] || 0;
        output.className = "";
        output.innerHTML = cardBox(
          "Monthly Must Report",
          `Month: ${monthKey} ‚Ä¢ Type: ${type}`,
          `<div class="totals"><div><b>Total ${type}:</b> ${money(total)}</div></div>`
        );
        return;
      }

      // All breakdown
      const totalMonthly = Object.values(byType).reduce((a,b)=>a+b,0);
      const rowsHtml = `
        <tr><td>Salaries</td><td class="tRight">${money(byType.salary)}</td></tr>
        <tr><td>Rent</td><td class="tRight">${money(byType.rent)}</td></tr>
        <tr><td>Water</td><td class="tRight">${money(byType.water)}</td></tr>
        <tr><td>Electric</td><td class="tRight">${money(byType.electric)}</td></tr>
        <tr><td>Other</td><td class="tRight">${money(byType.other)}</td></tr>
      `;
      const tbl = tableHtml(["Type", "Total"], rowsHtml);

      output.className = "";
      output.innerHTML = cardBox(
        "Monthly Must Breakdown",
        `Month: ${monthKey}`,
        tbl + `<div class="totals"><div><b>Total monthly must:</b> ${money(totalMonthly)}</div></div>`
      );
    };

    // ---------- button: Full Summary (your existing idea) ----------
    document.getElementById("openSummary").onclick = async () => {
      ensureChartsDestroyed();
      setMessage("");

      const r = getRange();
      if (!r) return setMessage("Select valid From and To dates.", "bad");

      setPrintMeta("Full Summary Report", `${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      const daily = await fetchDaily(r.from, r.to);
      const months = monthKeysBetween(r.from, r.to);
      const monthly = await fetchMonthlyForMonths(months);

      let totalSales = 0;
      let totalDailyExp = 0;
      let totalBank = 0;

      daily.forEach(x => {
        totalSales += Number(x.business || 0);
        totalDailyExp += Number(x.sameDayExpenses || x.expenses || x.exp || 0);
        totalBank += Number(x.bankSaving || x.bank || 0);
      });

      const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
      monthly.forEach(r => {
        const t = (r.type || "other").toLowerCase();
        const amt = Number(r.amount || 0);
        if (byType[t] === undefined) byType.other += amt;
        else byType[t] += amt;
      });

      const totalMonthlyMust = Object.values(byType).reduce((a,b)=>a+b,0);
      const totalExpenses = totalDailyExp + totalMonthlyMust;

      const netProfit = totalSales - totalExpenses;               // profit (excluding bank saving)
      const cashAfterBank = netProfit - totalBank;                // if bank saving moved out
      const totalAssets = netProfit + totalBank;                  // profit + bank saving

      // KPI cards
      const kpis = `
        <div class="kpiGrid">
          <div class="kpi"><div class="kpiLabel">Total Sales</div><div class="kpiValue">${money(totalSales)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Expenses</div><div class="kpiValue">${money(totalExpenses)}</div><div class="kpiSmall">Daily: ${money(totalDailyExp)} ‚Ä¢ Monthly: ${money(totalMonthlyMust)}</div></div>
          <div class="kpi"><div class="kpiLabel">Net Profit</div><div class="kpiValue">${money(netProfit)}</div><div class="kpiSmall">(Profit = Sales ‚àí Expenses)</div></div>
          <div class="kpi"><div class="kpiLabel">Bank Saving (separate)</div><div class="kpiValue">${money(totalBank)}</div></div>
          <div class="kpi"><div class="kpiLabel">Available Cash (Profit ‚àí Bank)</div><div class="kpiValue">${money(cashAfterBank)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Assets (Profit + Bank)</div><div class="kpiValue">${money(totalAssets)}</div></div>
        </div>
      `;

      // Charts data
      const labels = daily.map(x => x.date);
      const salesSeries = daily.map(x => Number(x.business || 0));
      const expSeries = daily.map(x => Number(x.sameDayExpenses || x.expenses || x.exp || 0));

      const charts = `
        <div class="chartCard">
          <div class="chartTitle">Daily Sales vs Daily Expenses</div>
          <canvas id="chartLine" height="120"></canvas>
        </div>

        <div class="chartCard">
          <div class="chartTitle">Expense Breakdown (Monthly must)</div>
          <canvas id="chartPie" height="140"></canvas>
        </div>
      `;

      // Tables (more info)
      const dailyRows = daily.map(x => {
        const s = Number(x.business || 0);
        const e = Number(x.sameDayExpenses || x.expenses || x.exp || 0);
        const b = Number(x.bankSaving || x.bank || 0);
        const p = s - e; // daily profit excluding monthly must
        return `<tr>
          <td>${x.date || ""}</td>
          <td class="tRight">${money(s)}</td>
          <td class="tRight">${money(e)}</td>
          <td class="tRight">${money(b)}</td>
          <td class="tRight">${money(p)}</td>
        </tr>`;
      }).join("");

      const dailyTbl = tableHtml(
        ["Date","Sales","Daily expenses","Bank saving","Profit (day)"],
        dailyRows || `<tr><td colspan="5" class="tCenter muted">No daily rows</td></tr>`
      );

      const monthlyTbl = tableHtml(
        ["Type","Total"],
        `
          <tr><td>Salary</td><td class="tRight">${money(byType.salary)}</td></tr>
          <tr><td>Rent</td><td class="tRight">${money(byType.rent)}</td></tr>
          <tr><td>Water</td><td class="tRight">${money(byType.water)}</td></tr>
          <tr><td>Electric</td><td class="tRight">${money(byType.electric)}</td></tr>
          <tr><td>Other</td><td class="tRight">${money(byType.other)}</td></tr>
        `
      );

      output.className = "";
      output.innerHTML = cardBox(
        "Full Summary Report",
        `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`,
        kpis +
        charts +
        `<div class="reportSectionTitle">Daily Summary Table</div>${dailyTbl}` +
        `<div class="reportSectionTitle">Monthly Must Breakdown (within range)</div>${monthlyTbl}`
      );

      // Draw charts
      const ctxLine = document.getElementById("chartLine");
      const ctxPie = document.getElementById("chartPie");

      chartLine = new Chart(ctxLine, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Sales", data: salesSeries, tension: 0.3 },
            { label: "Daily Expenses", data: expSeries, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,.8)" }, grid: { color: "rgba(255,255,255,.08)" } },
            y: { ticks: { color: "rgba(255,255,255,.8)" }, grid: { color: "rgba(255,255,255,.08)" } }
          }
        }
      });

      chartPie = new Chart(ctxPie, {
        type: "doughnut",
        data: {
          labels: ["Salary","Rent","Water","Electric","Other"],
          datasets: [{
            data: [byType.salary, byType.rent, byType.water, byType.electric, byType.other]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#fff" } } }
        }
      });
    };

    // ---------- NEW button: Full Financial Report (ALL IN ONE + more detail) ----------
    document.getElementById("openFinancial").onclick = async () => {
      ensureChartsDestroyed();
      setMessage("");

      const r = getRange();
      if (!r) return setMessage("Select valid From and To dates.", "bad");

      setPrintMeta("Full Financial Report", `${fmtDate(r.from)} to ${fmtDate(r.to)}`);

      const daily = await fetchDaily(r.from, r.to);
      const months = monthKeysBetween(r.from, r.to);
      const monthly = await fetchMonthlyForMonths(months);

      // totals
      let totalSales = 0, totalDailyExp = 0, totalBank = 0;
      daily.forEach(x => {
        totalSales += Number(x.business || 0);
        totalDailyExp += Number(x.sameDayExpenses || x.expenses || x.exp || 0);
        totalBank += Number(x.bankSaving || x.bank || 0);
      });

      const byType = { salary:0, rent:0, water:0, electric:0, other:0 };
      monthly.forEach(x => {
        const t = (x.type || "other").toLowerCase();
        const amt = Number(x.amount || 0);
        if (byType[t] === undefined) byType.other += amt;
        else byType[t] += amt;
      });

      const totalMonthlyMust = Object.values(byType).reduce((a,b)=>a+b,0);
      const totalExpenses = totalDailyExp + totalMonthlyMust;

      const netProfit = totalSales - totalExpenses;      // excludes bank
      const availableCash = netProfit - totalBank;       // after bank saving moved out
      const totalAssets = netProfit + totalBank;         // profit + bank saving

      // Worker salary aggregation (across range months)
      const salaryMap = {};
      monthly.filter(x => (x.type || "").toLowerCase() === "salary").forEach(x => {
        const w = (x.workerName || "Unknown").trim();
        salaryMap[w] = (salaryMap[w] || 0) + Number(x.amount || 0);
      });
      const salaryRows = Object.entries(salaryMap).sort((a,b)=>b[1]-a[1]);

      // KPI section
      const kpis = `
        <div class="kpiGrid">
          <div class="kpi"><div class="kpiLabel">Total Sales</div><div class="kpiValue">${money(totalSales)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Daily Expenses</div><div class="kpiValue">${money(totalDailyExp)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Monthly Must</div><div class="kpiValue">${money(totalMonthlyMust)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Expenses (All)</div><div class="kpiValue">${money(totalExpenses)}</div></div>
          <div class="kpi"><div class="kpiLabel">Net Profit (Sales ‚àí Expenses)</div><div class="kpiValue">${money(netProfit)}</div></div>
          <div class="kpi"><div class="kpiLabel">Bank Saving (separate)</div><div class="kpiValue">${money(totalBank)}</div></div>
          <div class="kpi"><div class="kpiLabel">Available Cash (Profit ‚àí Bank)</div><div class="kpiValue">${money(availableCash)}</div></div>
          <div class="kpi"><div class="kpiLabel">Total Assets (Profit + Bank)</div><div class="kpiValue">${money(totalAssets)}</div></div>
        </div>
      `;

      // Daily table (detailed)
      const dailyRows = daily.map(x => {
        const s = Number(x.business || 0);
        const e = Number(x.sameDayExpenses || x.expenses || x.exp || 0);
        const b = Number(x.bankSaving || x.bank || 0);
        const p = s - e;
        return `<tr>
          <td>${x.date || ""}</td>
          <td class="tRight">${money(s)}</td>
          <td class="tRight">${money(e)}</td>
          <td class="tRight">${money(b)}</td>
          <td class="tRight">${money(p)}</td>
        </tr>`;
      }).join("");

      const dailyTbl = tableHtml(
        ["Date","Sales","Daily expenses","Bank saving","Profit (day)"],
        dailyRows || `<tr><td colspan="5" class="tCenter muted">No daily rows</td></tr>`
      );

      // Monthly breakdown table
      const monthlyBreakTbl = tableHtml(
        ["Type","Total"],
        `
          <tr><td>Salary</td><td class="tRight">${money(byType.salary)}</td></tr>
          <tr><td>Rent</td><td class="tRight">${money(byType.rent)}</td></tr>
          <tr><td>Water</td><td class="tRight">${money(byType.water)}</td></tr>
          <tr><td>Electric</td><td class="tRight">${money(byType.electric)}</td></tr>
          <tr><td>Other</td><td class="tRight">${money(byType.other)}</td></tr>
        `
      );

      // Salary by workers table
      const salaryTbl = tableHtml(
        ["Worker","Total salary paid"],
        salaryRows.map(([w,v]) => `<tr><td>${w}</td><td class="tRight">${money(v)}</td></tr>`).join("")
        || `<tr><td colspan="2" class="tCenter muted">No salary data in range</td></tr>`
      );

      // Charts
      const labels = daily.map(x => x.date);
      const salesSeries = daily.map(x => Number(x.business || 0));
      const expSeries = daily.map(x => Number(x.sameDayExpenses || x.expenses || x.exp || 0));

      const charts = `
        <div class="chartCard">
          <div class="chartTitle">Daily Sales vs Daily Expenses</div>
          <canvas id="finLine" height="120"></canvas>
        </div>
        <div class="chartCard">
          <div class="chartTitle">All Expenses Breakdown</div>
          <canvas id="finPie" height="140"></canvas>
        </div>
      `;

      output.className = "";
      output.innerHTML = cardBox(
        "Full Financial Report",
        `Range: ${fmtDate(r.from)} to ${fmtDate(r.to)}`,
        kpis +
        charts +
        `<div class="reportSectionTitle">Daily Table (Sales ‚Ä¢ Expenses ‚Ä¢ Bank ‚Ä¢ Profit)</div>${dailyTbl}` +
        `<div class="reportSectionTitle">Monthly Must Breakdown (Salary/Rent/Water/Electric/Other)</div>${monthlyBreakTbl}` +
        `<div class="reportSectionTitle">Salary by Workers (within range)</div>${salaryTbl}`
      );

      const ctxLine = document.getElementById("finLine");
      const ctxPie = document.getElementById("finPie");

      chartLine = new Chart(ctxLine, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Sales", data: salesSeries, tension: 0.3 },
            { label: "Daily Expenses", data: expSeries, tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,.8)" }, grid: { color: "rgba(255,255,255,.08)" } },
            y: { ticks: { color: "rgba(255,255,255,.8)" }, grid: { color: "rgba(255,255,255,.08)" } }
          }
        }
      });

      chartPie = new Chart(ctxPie, {
        type: "doughnut",
        data: {
          labels: ["Daily Expenses","Salary","Rent","Water","Electric","Other"],
          datasets: [{
            data: [totalDailyExp, byType.salary, byType.rent, byType.water, byType.electric, byType.other]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#fff" } } }
        }
      });
    };
  </script>
</body>
</html>
