<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deruja Beauty Hub and Lounge - Reports</title>

  <!-- IMPORTANT: premium theme -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap">

    <!-- Premium top bar -->
    <div class="card topbar noPrint">
      <div class="brand">
        <img src="assets/logo.png" alt="Logo">
        <div class="title">
          <strong>Deruja Beauty Hub and Lounge</strong>
          <span>Reports ‚Ä¢ Print ready</span>
        </div>
      </div>

      <div class="actions">
        <button class="btn btnGhost" id="backBtn">‚Üê Back</button>
        <button class="btn btnPrimary" id="printBtn">üñ® Print</button>
        <button class="btn btnDanger" id="logoutBtn">‚éã Logout</button>
      </div>
    </div>

    <div class="grid">

      <!-- Filters -->
      <section class="card noPrint">
        <div class="sectionTitle">
          <h2>Report Selection</h2>
          <p>Select date range or month then click Open</p>
        </div>

        <div class="pad">
          <label>Daily / Range (From)</label>
          <input id="fromDate" type="date">

          <label>Daily / Range (To)</label>
          <input id="toDate" type="date">

          <label>Monthly report (month)</label>
          <input id="monthKey" type="month">

          <label>Monthly type</label>
          <select id="monthType">
            <option value="salary">Salary (by workers)</option>
            <option value="rent">Paid rental</option>
            <option value="water">Water bills</option>
            <option value="electric">Electric bills</option>
          </select>

          <div class="row">
            <button class="btn btnPrimary" id="openDaily">Open daily business</button>
            <button class="btn btnGhost" id="openExpense">Open expenses</button>
          </div>
          <div class="row">
            <button class="btn btnPrimary" id="openMonthly">Open monthly must</button>
          </div>

          <div class="msg" id="msg"></div>
        </div>
      </section>

      <!-- Output -->
      <section class="card" id="reportArea">
        <div class="sectionTitle">
          <h2>Report Output</h2>
          <p class="smallMuted">Tip: Print button makes PDF / paper report</p>
        </div>

        <div class="pad">

          <!-- PRINT HEADER (shows only when printing) -->
          <div class="printHeader" id="printHeader">
            <div class="printHeaderRow">
              <img src="assets/logo.png" alt="Logo">
              <div>
                <h1>Deruja Beauty Hub and Lounge</h1>
                <div class="meta">
                  No39/A new rosita bazar kotagala<br/>
                  Mobile No: 051-224 4456 / 076-669 3456<br/>
                  <span id="printReportTitle"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- report output -->
          <div class="reportBox" id="output">Select a report and click Open.</div>

        </div>
      </section>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_pQt0C5X3R9tmVl8SRGT-DQ3eoNvdOEw",
      authDomain: "salonsales-32a19.firebaseapp.com",
      projectId: "salonsales-32a19",
      storageBucket: "salonsales-32a19.firebasestorage.app",
      messagingSenderId: "727392891815",
      appId: "1:727392891815:web:1ea28d2335b6ee9a363c82"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "index.html";
    });

    document.getElementById("backBtn").onclick = () => window.location.href = "app.html";
    document.getElementById("printBtn").onclick = () => window.print();
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href="index.html";
    };

    const msg = document.getElementById("msg");
    const output = document.getElementById("output");
    const printTitle = document.getElementById("printReportTitle");

    const money = (n) => (Number(n||0)).toFixed(2);

    function getRange() {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      if (!from || !to) return null;
      if (from > to) return null;
      return { from, to };
    }

    function setPrintTitle(title, sub){
      const now = new Date();
      printTitle.textContent = `${title}${sub ? " | " + sub : ""} | Printed: ${now.toLocaleString()}`;
    }

    // Daily business report
    document.getElementById("openDaily").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) { msg.className="msg msgErr"; msg.textContent = "Select valid From and To dates."; return; }

      setPrintTitle("Daily Business Report", `Range: ${r.from} to ${r.to}`);

      const qy = query(
        collection(db, "dailySales"),
        where("date", ">=", r.from),
        where("date", "<=", r.to)
      );

      const snap = await getDocs(qy);
      let totalBusiness = 0;
      let totalBank = 0;

      const rows = [];
      snap.forEach(d => {
        const x = d.data();
        totalBusiness += Number(x.businessTotal || 0);
        totalBank += Number(x.bankSaving || 0);
        rows.push({ date: x.date, businessTotal: x.businessTotal || 0, bankSaving: x.bankSaving || 0 });
      });

      rows.sort((a,b)=> a.date.localeCompare(b.date));

      output.innerHTML = `
        <div style="font-weight:950; font-size:15px; margin-bottom:6px;">Daily Business Report</div>
        <div class="smallMuted">Range: ${r.from} to ${r.to}</div>
        <br/>
        <table>
          <thead><tr><th>Date</th><th>Business</th><th>Bank saving</th></tr></thead>
          <tbody>
            ${rows.map(x => `<tr><td>${x.date}</td><td>${money(x.businessTotal)}</td><td>${money(x.bankSaving)}</td></tr>`).join("")}
          </tbody>
        </table>
        <br/>
        <div style="font-weight:950;">Total business: ${money(totalBusiness)}</div>
        <div style="font-weight:950;">Total bank saving: ${money(totalBank)}</div>
      `;
    };

    // Total expenses report
    document.getElementById("openExpense").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const r = getRange();
      if (!r) { msg.className="msg msgErr"; msg.textContent = "Select valid From and To dates."; return; }

      setPrintTitle("Total Expenses Report (Daily)", `Range: ${r.from} to ${r.to}`);

      const qDaily = query(
        collection(db, "dailySales"),
        where("date", ">=", r.from),
        where("date", "<=", r.to)
      );

      const snap = await getDocs(qDaily);
      let totalDailyExpenses = 0;
      const rows = [];

      snap.forEach(d => {
        const x = d.data();
        totalDailyExpenses += Number(x.sameDayExpenses || 0);
        rows.push({ date: x.date, sameDayExpenses: x.sameDayExpenses || 0 });
      });

      rows.sort((a,b)=> a.date.localeCompare(b.date));

      output.innerHTML = `
        <div style="font-weight:950; font-size:15px; margin-bottom:6px;">Total Expenses Report (Daily)</div>
        <div class="smallMuted">Range: ${r.from} to ${r.to}</div>
        <br/>
        <table>
          <thead><tr><th>Date</th><th>Same-day Expenses</th></tr></thead>
          <tbody>
            ${rows.map(x => `<tr><td>${x.date}</td><td>${money(x.sameDayExpenses)}</td></tr>`).join("")}
          </tbody>
        </table>
        <br/>
        <div style="font-weight:950;">Total daily expenses: ${money(totalDailyExpenses)}</div>
      `;
    };

    // Monthly must report
    document.getElementById("openMonthly").onclick = async () => {
      msg.className = "msg";
      msg.textContent = "";

      const monthKey = document.getElementById("monthKey").value;
      const type = document.getElementById("monthType").value;
      if (!monthKey) { msg.className="msg msgErr"; msg.textContent = "Select month."; return; }

      const typeTitle = (type === "salary") ? "Monthly Salary Report (By workers)" : `Monthly Must Report (${type.toUpperCase()})`;
      setPrintTitle(typeTitle, `Month: ${monthKey}`);

      const qMonthly = query(
        collection(db, "monthlyExpenses"),
        where("monthKey", "==", monthKey),
        where("type", "==", type)
      );

      const snap = await getDocs(qMonthly);
      let total = 0;
      const items = [];
      snap.forEach(d => {
        const x = d.data();
        total += Number(x.amount || 0);
        items.push(x);
      });

      if (type === "salary") {
        const byWorker = {};
        items.forEach(x => {
          const w = (x.workerName || "Unknown").trim() || "Unknown";
          byWorker[w] = (byWorker[w] || 0) + Number(x.amount || 0);
        });

        const workers = Object.entries(byWorker).sort((a,b)=> b[1]-a[1]);

        output.innerHTML = `
          <div style="font-weight:950; font-size:15px; margin-bottom:6px;">Monthly Salary Report (By workers)</div>
          <div class="smallMuted">Month: ${monthKey}</div>
          <br/>
          <table>
            <thead><tr><th>Worker</th><th>Total salary paid</th></tr></thead>
            <tbody>
              ${workers.map(([w,amt]) => `<tr><td>${w}</td><td>${money(amt)}</td></tr>`).join("")}
            </tbody>
          </table>
          <br/>
          <div style="font-weight:950;">Total salaries paid: ${money(total)}</div>
        `;
      } else {
        output.innerHTML = `
          <div style="font-weight:950; font-size:15px; margin-bottom:6px;">Monthly Must Report</div>
          <div class="smallMuted">Type: ${type.toUpperCase()} | Month: ${monthKey}</div>
          <br/>
          <table>
            <thead><tr><th>Paid Date</th><th>Amount</th><th>Note</th></tr></thead>
            <tbody>
              ${items.sort((a,b)=> (a.paidDate||"").localeCompare(b.paidDate||""))
                .map(x => `<tr><td>${x.paidDate||""}</td><td>${money(x.amount)}</td><td>${x.note||""}</td></tr>`).join("")}
            </tbody>
          </table>
          <br/>
          <div style="font-weight:950;">Total paid: ${money(total)}</div>
        `;
      }
    };
  </script>
</body>
</html>
